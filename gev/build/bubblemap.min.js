/* bubblemap 2018-09-05 */
var gtexBubbleMapConfig=function(){function getEqtlUrl(geneId){return geneId.startsWith("ENSG")?serverHost+serverVersion+"/association/singleTissueEqtl?gencodeId="+geneId:serverHost+serverVersion+"/association/singleTissueEqtl?geneSymbol="+geneId}function getGeneUrl(geneId){return serverHost+serverVersion+"/reference/gene?geneId=gencodeVersion=v19&genomeBuild=GRCh37%2Fhg19&geneId="+geneId}function getTissueUrl(){return serverHost+serverVersion+"/dataset/tissueSummary"}function getExonsUrl(geneId){return geneId.startsWith("ENSG")||console.error("Exon query requires a gencodeId."),serverHost+serverVersion+"/reference/exon?datasetId=gtex_v7&gencodeId="+geneId}function getEqtlBoxplotUrl(){return serverHost+serverVersion+"/association/dyneqtl"}var serverHost="https://gtexportal.org/rest/",serverVersion="v1",config={id:"eqtlBubbles",rootDiv:"gtexBB",bbMapDiv:"bbMap",bbMapCanvasDiv:"bbMapCanvas",ldCanvasDiv:"ldCanvas",dialogDiv:"bbMap-dialog",legendDiv:"bbLegends",modalDiv:"bbMap-modal",tooltipId:"bbTooltip",infoDiv:"bbInfo",padding:{left:280,top:60},width:void 0,height:void 0,yLabelShow:!0,yLabelOrient:"left",xLabelOrient:"bottom",colorMax:1,colorTitle:"Color Range (NES)",radiusTitle:"Bubble Size in Zoom ViewPort (-log10(P-value))",ldTitle:"Linkage Disequlibrium",dataType:"diverging",serverHost:serverHost,badgeData:{},zoomN:80,zoomCellW:15,ldCutoff:.1};return{build:function(gene){return config},plotviz:function(x,y){return{width:250,height:250,outlierJitter:.5,leftAxisLabel:"Rank Norm. Express.",margin:{top:0,left:5,right:5,bottom:0},titleContent:x+" "+y,leftLabelX:0,viewerLeftSpacing:.3,viewerBottomSpacing:0,tickRotation:0,tickAlign:"middle",tickTranslation:0}},getTissueUrl:getTissueUrl,getEqtlUrl:getEqtlUrl,getExonsUrl:getExonsUrl,getEqtlBoxplotUrl:getEqtlBoxplotUrl,getLDUrl:function(gene){return serverHost+serverVersion+"/dataset/ld?gencodeId="+gene.gencodeId},getGeneUrl:getGeneUrl}}(),gtexBubbleMapDataUtil=function(){var generateShortVariantId=function(id){var temp=id.split("_");return 1==temp[2].length&&1==temp[3].length?id:(temp[2].length>temp[3].length?(temp[2]="del",temp.splice(3,1)):temp[3].length>temp[2].length?(temp[3]="ins",temp.splice(2,1)):(temp[3]="sub",temp.splice(2,1)),temp.join("_"))};return{parseGene:function(json,geneId){var gene;if(1==json.gene.length)gene=json.gene[0];else if(json.gene.length>1){var _matchBySymbol=function(g){new RegExp(geneId+"$","i").test(g.geneSymbol)&&(gene=g)};json.gene.forEach(_matchBySymbol)}if(void 0===gene)throw alert("Query gene not found: "+geneId),"Gene not found";return gene},parseEqtl:function(json,tss){var key="singleTissueEqtl",mat={x:[],y:[],data:[],snp:{}};if(!json.hasOwnProperty(key))throw"Json structure parsing error.";return 0==json[key].length?void console.warn("Eqtl json structure returns no data for this gene"):(["tissueSiteDetailId","snpId","variantId","pos","pValue","nes"].forEach(function(d){if(!json[key][0].hasOwnProperty(d))throw"Required attribute "+d+" does not exist."}),json[key].forEach(function(d){var tissue=d.tissueSiteDetailId,snpId=d.snpId,variantId=d.variantId,truncatedVariantId=generateShortVariantId(d.variantId),start=d.pos,p=d.pValue,effectsize=d.nes,snpData={variantId:variantId,truncatedVariantId:truncatedVariantId,rsId:snpId,pos:parseInt(start),dist:parseInt(start)-parseInt(tss)},x=variantId,data={x:x,y:tissue,variantId:variantId,truncatedVariantId:truncatedVariantId,rsId:snpId,value:parseFloat(effectsize).toPrecision(3),r:-(Math.log(p)/Math.log(10)).toPrecision(3)};-1==mat.y.indexOf(tissue)&&mat.y.push(tissue),-1==mat.x.indexOf(x)&&mat.x.push(x),void 0===mat.snp[x]&&(mat.snp[x]=snpData),mat.data.push(data)}),mat.y.sort(function(a,b){return a<b?-1:1}),mat.x.sort(function(a,b){return mat.snp[a].pos<mat.snp[b].pos?-1:1}),mat.xlab=mat.x.map(function(x){return x}),mat)},parseTissue:function(rawJson){var json={};rawJson.tissueSummary.forEach(function(tissueEntry,i,arr){json[tissueEntry.tissueSiteDetailId]=tissueEntry});var tissues={};return d3.keys(json).forEach(function(k){var v=json[k];tissues[k]=v.rnaSeqAndGenotypeSampleCount}),tissues},parseExon:function(json){if(json.hasOwnProperty("exon"))return json.exon;throw"Json structure of the exons is not recognized."},parseLD:function(json){var ld={};return json.forEach(function(d){var id=d.snp1.split(",")[0]+d.snp2.split(",")[0];ld[id]=parseFloat(d.r2)}),ld}}}(),bubbleMapUtil=function(){var colorStock={blues:["rgb(247,251,255)","rgb(222,235,247)","rgb(198,219,239)","rgb(158,202,225)","rgb(107,174,214)","rgb(66,146,198)","rgb(33,113,181)","rgb(8,81,156)","rgb(8,48,107)"],reds:["rgb(255,245,240)","rgb(254,224,210)","rgb(252,187,161)","rgb(252,146,114)","rgb(251,106,74)","rgb(239,59,44)","rgb(203,24,29)","rgb(165,15,21)","rgb(103,0,13)"],greys:["rgb(255,255,255)","rgb(37,37,37)","rgb(0,0,0)"],oranges:["rgb(255,245,235)","rgb(254,230,206)","rgb(253,208,162)","rgb(253,174,107)","rgb(253,141,60)","rgb(241,105,19)","rgb(217,72,1)","rgb(166,54,3)","rgb(127,39,4)"],greens:["rgb(247,252,245)","rgb(229,245,224)","rgb(199,233,192)","rgb(161,217,155)","rgb(116,196,118)","rgb(65,171,93)","rgb(35,139,69)","rgb(0,109,44)","rgb(0,68,27)"],purples:["rgb(252,251,253)","rgb(239,237,245)","rgb(218,218,235)","rgb(188,189,220)","rgb(158,154,200)","rgb(128,125,186)","rgb(106,81,163)","rgb(84,39,143)","rgb(63,0,125)"],steelblues:["#f7fafc","#dee9f2","#c6d9e9","#adc8df","#95b8d6","#7da8cc","#6497c3","#4c87b9","#4076a3","#36648B"],"6class":["#f7fafc","#809d79","#e66c54","#f5bd49","#7bb67f","#7c65ff"],bluered:["#0571b0","#f7f7f7","#ca0020"]},checkDataIntegrity=function(mat){if(void 0===mat)throw"Fatal Error: mat must be defined";if(void 0===mat.x||0==mat.x.length)throw"Fatal Error. mat.x must be provided";if(void 0===mat.y||0==mat.y.length)throw"Fatal Error. mat.y must be provided";if(void 0===mat.data||0==mat.data.length)throw"Fatal Error. mat.data must be provided"},setOrdinalScale=function(args){return d3.scale.ordinal().rangeBands(args.range,.1,1).domain(args.domain)},setRscale=function(radius,max){return void 0===max&&(max=15),d3.scale.sqrt().domain([0,max]).range([0,radius])},setCscale=function(dataType,data,max){var colors,domain=[];switch(dataType){case"diverging":max=void 0===max?d3.max(data,function(d){return Math.abs(d.value)}):max,domain=[-max,0,max],colors="bluered";break;default:max=void 0===max?d3.max(data,function(d){return d.value}):max,domain=[0,max],colors="steelblues"}var range=colorStock[colors];return d3.scale.linear().domain(domain).range(range)},createSvg=function(div,args,id,style){if(void 0===div)throw"Must provide svg DOM ID";void 0===args&&(args={});var svgW=void 0===args.width?$("#"+div).width():args.width,svgH=void 0===args.height?200:args.height,svg=d3.select("#"+div).append("svg").attr({width:svgW,height:svgH});return void 0!==id&&svg.attr("id",id),void 0!==style&&svg.style(style),svg},makeColumnLabels=function(g,data,scale,ypos){var id="xLabel",style={"font-size":12,"font-family":"arial",fill:"#aaa"},gg=g.select("#"+id);gg=gg.empty()?g.append("g").attr("id",id):gg;var angle=-90,_rotate=function(d){return"translate("+(scale(d)+4)+","+ypos+") rotate("+angle+")"},cols=gg.selectAll(".xlab").data(data,function(d){return d});return cols.enter().append("text").text(function(d){return d}),cols.exit().remove(),cols.attr({x:0,y:0,class:"xlab",col:function(d){return d},"text-anchor":"end"}).attr(style).attr("transform",_rotate),cols};return{checkDataIntegrity:checkDataIntegrity,setOrdinalScale:setOrdinalScale,setCscale:setCscale,setRscale:setRscale,createSvg:createSvg,makeRowLabels:function(g,data,scale,onLeft,xadjust,yadjust){var id="yLabel",style={"font-size":12,"font-family":"arial",fill:"#aaa"},gg=g.select("#"+id);gg=gg.empty()?g.append("g").attr("id",id):gg;var findLast=function(){return scale(data[data.length-1])},rows=gg.selectAll("text").data(data,function(d){return d});return rows.enter().append("text").text(function(d){return d}),rows.exit().remove(),rows.attr({x:function(){return onLeft?0+xadjust:findLast()+xadjust},y:function(d){return void 0!==yadjust?scale(d)+yadjust:2/3*scale.rangeBand()},"text-anchor":function(){return onLeft?"end":"start"},row:function(d){return d}}).attr(style).classed("ylab",!0),rows},makeColumnLabels:makeColumnLabels,makeColumnMarkers:function(args){var id="xMarkerGroup",gg=args.g.select("#"+id);if(gg=gg.empty()?args.g.append("g").attr("id",id):gg,void 0!==args.data){var scale=args.xscale,data=args.data,getX=function(d){return scale(d)},myClass="xMarker",markers=gg.selectAll("."+myClass).filter(function(){return!d3.select(this).classed("sortMarker")}).data(data,function(d){return d});return markers.enter().append("path"),markers.exit().remove(),markers.attr({d:d3.svg.symbol().type("triangle-down"),class:myClass,fill:"none",col:function(d){return d}}).attr("transform",function(d){return"translate("+getX(d)+","+args.markerAdjust+") scale(0.75)"}),markers}},makeCircles:function(g,scale,data){var circles=g.selectAll(".dcircle").data(data,function(d){return d.x+d.y});circles.enter().append("circle"),circles.exit().remove(),circles.attr({cx:function(d){return scale.X(d.x).toFixed(2)},cy:function(d){return scale.Y(d.y).toFixed(2)},r:function(d){return scale.R(d.r).toFixed(2)},fill:function(d){return(d.filters?d3.values(d.filters).filter(function(d){return d}):[]).length>0?"#eee":scale.C(d.value)},class:function(){return"dcircle"},col:function(d){return d.x},row:function(d){return d.y}})},makeLegend:function(div,title,radiusTitle,scale,cellW){$("#"+div).html("");var dim={width:450,height:60},svg=createSvg(div,dim),g=svg.append("g").attr("id","#cLegend"),initX=10,initY=20;g.append("text").text(title).attr({x:initX,y:initY,"font-size":10,fill:"black"});var w=cellW,data=d3.range(-1,1.2,.2);initX+=10,initY+=10;var colors=[];g.selectAll("rect").data(data).enter().append("rect").attr({width:w,height:w,x:function(d,i){return initX+i*w},y:initY,fill:function(d){return colors.push(scale.C(d)),scale.C(d)}}),data=data.map(function(d){return d.toFixed(1)}),g.selectAll(".clabels").data(data).enter().append("text").text(function(d){return d}).attr({x:function(d,i){return initX+i*w+2},y:initY+10+w,"font-size":6,fill:function(d,i){return i%2==1?"black":"#aaa"}}),g=svg.append("g").attr("id","#rLegend"),initX-=10,initY-=10,initX+=(data.length+2)*w,g.append("text").text(radiusTitle).attr({x:initX,y:initY,"font-size":10,fill:"black"}),data=[30,20,10,5,2,1],initX+=10,initY+=10,g.selectAll("circle").data(data).enter().append("circle").attr({cx:function(d,i){return initX+i*w},cy:initY+w/2,fill:scale.C(-1),r:function(d){return scale.R(d)}}),initX-=5,g.selectAll(".rlabels").data(data).enter().append("text").text(function(d){return d}).attr({x:function(d,i){return initX+i*w},y:initY+10+w,"font-size":6,fill:"black"})},createDialog:function(parentDivId,dialogDivId,title){var template='<div id="'+dialogDivId+'" title="'+title+'"><div class="bbMap-clear">Clear All</div><div class="bbMap-content"></div></div>';$("#"+parentDivId).append(template),$("#"+dialogDivId).dialog({autoOpen:!1,position:[20,20]}),$("#"+dialogDivId).dialog("moveToTop"),$(".bbMap-clear").click(function(){$(".bbMap-content").empty()})},createCanvas:function(div,width,height,margin,className){return d3.select("#"+div).select("canvas").remove(),void 0!==className&&d3.select("#"+div).classed(className,!0),d3.select("#"+div).style("position","relative").append("canvas").attr({width:width+margin,height:height+10}).style({position:"absolute"})},renderCanvas:function(canvas,scale,data){var context=canvas.node().getContext("2d");context.fillStyle="#fff",context.rect(0,0,canvas.attr("width"),canvas.attr("height")),context.fill(),data.forEach(function(d){var filterlist=d.filters?d3.values(d.filters).filter(function(d){return d}):[];context.beginPath(),context.fillStyle=filterlist.length>0?"#eee":scale.C(d.value),context.arc(scale.X(d.x),scale.Y(d.y),scale.R(d.r),0,2*Math.PI),context.fill(),context.closePath()})},createBrush:function(scale,ext,svg,height){var brush=d3.svg.brush().x(scale.X).extent(ext);return svg.append("g").attr("id","bbrush").call(brush).selectAll("rect").attr("height",height).style({"stroke-width":0,opacity:.3}),brush}}}(),bubbleMap=function(mat,config){function setParams(){bubbleMapUtil.checkDataIntegrity(mat),self.tooltip=new toolTip(self.svg,config.tooltipId),void 0===padding?padding={left:0,top:0}:["top","left"].forEach(function(d){void 0===padding[d]&&(padding[d]=0)}),checkHeight(),width=void 0===config.width?self.svg.attr("width")-2*padding.left:config.width-2*padding.left}function checkHeight(){var _adjustMapH=function(){var l=mat.y.length;return void 0===self.scale&&setScales(),self.scale.Y.rangeBand()*l},_adjustSvgH=function(){return _adjustMapH()+2*padding.top+220};height=_adjustMapH(),self.svg.attr("height",_adjustSvgH())}function setScales(){self.scale={X:bubbleMapUtil.setOrdinalScale({range:[0,cellW*mat.x.length],domain:mat.x}),Y:bubbleMapUtil.setOrdinalScale({range:[0,cellW*mat.y.length+50],domain:mat.y}),C:bubbleMapUtil.setCscale(config.dataType,mat.data,1),R:bubbleMapUtil.setRscale(cellW/2,30)}}function render(update){var zoomId=config.id+"Zoom";if(!update){self.zoomGroup=self.svg.append("g").attr({id:zoomId});var initX=padding.left,initY=padding.top;self.zoomGroup.attr("transform","translate("+initX+","+initY+")"),bubbleMapUtil.makeLegend(config.legendDiv,config.colorTitle,config.radiusTitle,self.scale,cellW)}var ypos=self.scale.Y(mat.y[mat.y.length-1])+2.5*self.scale.Y.rangeBand();bubbleMapUtil.makeColumnLabels(self.zoomGroup,mat.x,self.scale.X,ypos),bubbleMapUtil.makeRowLabels(self.zoomGroup,mat.y,self.scale.Y,!0,-24,4),bubbleMapUtil.makeCircles(self.zoomGroup,self.scale,mat.data)}var height,width,self=this,svgDivId=config.bbMapDiv,mat=mat,padding=config.padding,cellW=config.zoomCellW||15;this.svg,this.scale,this.zoomGroup=void 0,this.bubbleEvents={},this.id=config.id,this.tooltip,this.init=function(){var top=config.needMini?parseInt(d3.select("#"+config.bbMapCanvasDiv).select("canvas").attr("height")):50;d3.select("#"+svgDivId).attr("style","position: relative; top:"+top+"px;"),this.svg=bubbleMapUtil.createSvg(svgDivId),setParams(),this.draw(!1)},this.getPadding=function(){return padding},this.getCellSize=function(){return cellW},this.draw=function(isUpdate){setScales(),isUpdate&&checkHeight(),render(isUpdate)},this.update=function(newmat,state){mat=newmat,this.draw(!0)}},bubbleMapBrush=function(svgId,source,target,config){function moveTarget(){var zoomId=config.id+"Zoom";!function(){d3.select("#"+zoomId).selectAll(".dcircle").classed("hide",!0),d3.select("#"+zoomId).selectAll(".xlab").classed("hide",!0),d3.select("#"+zoomId).selectAll(".xMarker").classed("hide",!0),d3.select("#"+zoomId).selectAll(".ldbox").classed("hide",!0),d3.select("#"+zoomId).selectAll(".ldline").classed("hide",!0),self.xlist.forEach(function(d){var col='[col="'+d+'"]';d3.select("#"+zoomId).selectAll("circle"+col).classed("hide",!1),d3.select("#"+zoomId).selectAll("rect"+col).classed("hide",!1),d3.select("#"+zoomId).selectAll(".xlab"+col).classed("hide",!1),d3.select("#"+zoomId).selectAll(".xMarker"+col).classed("hide",!1),d3.select("#"+zoomId).selectAll(".ldbox"+col).classed("hide",!1),d3.select("#"+zoomId).selectAll(".ldline"+col).classed("hide",!1)})}();var x=(-target.scale.X(self.xlist[0])+target.scale.X.rangeBand()).toFixed(3),_move=function(d){d.attr({transform:"translate("+x+",0)"})};target.zoomGroup.selectAll(".dcircle").call(_move),d3.select("#"+zoomId+" #xLabel").call(_move),d3.select("#"+zoomId+" #xMarkerGroup").call(_move),d3.selectAll("#"+zoomId+" .additionalRow").call(_move),self.actions.forEach(function(action){action(x)})}var width,height,brush,self=this;this.xlist,this.svg,this.actions=[],this.scale=source.scale,this.defaultRange=function(){return this.scale.X.domain().slice(0,config.zoomN)},this.update=function(scale){void 0!==scale?this.create(scale):this.create()},this.addEvent=function(callback){this.actions.push(callback)},this.create=function(scale){void 0!==scale&&(this.scale=scale),width=source.canvas.attr("width"),height=source.canvas.attr("height"),this.xlist=this.defaultRange();var head=this.xlist[0],tail=this.xlist[this.xlist.length-1],ext=[self.scale.X(head),self.scale.X(tail)];!function(){d3.select("#"+svgId).remove()}();var style={border:"1px solid #eee",position:"absolute","z-index":"500"};self.svg=bubbleMapUtil.createSvg(config.bbMapCanvasDiv,{width:width,height:height},svgId,style),brush=bubbleMapUtil.createBrush(self.scale,ext,self.svg,height),brush.on("brush",function(){self.brushEvent(brush.extent())}),moveTarget()},this.brushEvent=function(ext){if(void 0===ext&&(ext=brush.extent()),ext[0]-ext[1]==0){var winSize=config.zoomN/2,dist=self.scale.X.rangeBand()*winSize;ext=[ext[0]-dist<0?0:ext[0]-dist,ext[0]+dist>width?width:ext[0]+dist],brush.extent(ext),self.svg.select("#bbrush").call(brush)}this.xlist=self.scale.X.domain().filter(function(d){return ext[0]<=self.scale.X(d)&&ext[1]>=self.scale.X(d)});var width=this.xlist.length*target.getCellSize()+target.getPadding().left;width>parseInt(target.svg.attr("width"))&&target.svg.attr("width",width),moveTarget()}},bubbleMapMini=function(mat,config){function render(){self.canvas=bubbleMapUtil.createCanvas(config.bbMapCanvasDiv,width,height,2*cellW,"bbMap-canvas"),bubbleMapUtil.renderCanvas(self.canvas,self.scale,mat.data)}function setDimensions(){var _initConfigWidth=function(){return void 0===width?.8*$("#"+config.bbMapCanvasDiv).width():width},_setCellW=function(){var l=mat.x.length,w=width/l,min=minCellW,max=maxCellW;return w<min?min:w>max?max:w},_adjust=function(){var w=cellW*mat.x.length;return w>width?w:width};width=_initConfigWidth(),cellW=_setCellW(),width=_adjust(),cellH=cellW,height=cellH*mat.y.length>minH?cellH*mat.y.length:minH}function setScales(){self.scale={X:bubbleMapUtil.setOrdinalScale({range:[0,width],domain:mat.x}),Y:bubbleMapUtil.setOrdinalScale({range:[15,height],domain:mat.y}),C:bubbleMapUtil.setCscale(config.dataType,mat.data,1),R:bubbleMapUtil.setRscale(cellW/2)}}var cellW,cellH,self=this,mat=mat,minCellW=2,maxCellW=5,minH=40,height=config.height,width=config.width;this.canvas,this.scale={},this.init=function(){bubbleMapUtil.checkDataIntegrity(mat),setDimensions(),setScales(),render()},this.update=function(data){mat=data,setDimensions(),setScales(),render()}},toolTip=function(svg,id){this.svg=svg,this.id=id;var self=this;this.show=function(info,x,y){move(x,y),$("#"+self.id).show(),$("#"+self.id).html(info),d3.select("#"+self.id).transition().duration(200).style("opacity",1)},this.hide=function(){move(),d3.select("#"+self.id).transition().duration(50).style("opacity",0)};var move=function(x,y){void 0===x&&(x=d3.event.pageX,y=d3.event.pageY),x+=15,y-=50,$("#"+self.id).css({left:x+"px",top:y+"px"})}},gtexBubbleMap=function(geneId,config,urls,useRsId){function setMini(){config.needMini=mat.x.length>config.zoomN}function clear(){d3.select("#"+config.bbMapDiv).selectAll("*").remove(),d3.select("#"+config.bbMapCanvasDiv).selectAll("*").remove(),d3.select("#"+config.ldCanvasDiv).selectAll("*").remove(),showSpinner(),$("#bbSnpSearch").val(""),$("#pvalueSlider").val(0),$("#pvalueLimit").val(0),$("#effectSizeSlider").val(0),$("#effectSizeLimit").val(0),$("#filterInfo").hide(),$("#"+config.infoDiv).html(""),config.ldData=void 0}function render(){config.needMini&&(bMapMini=new bubbleMapMini(mat,config),bMapMini.init()),bMap=new bubbleMap(mat,config),bMap.init(),self.changeXLabels(!1),config.needMini&&(bMapBrush=new bubbleMapBrush("bbrushSvg",bMapMini,bMap,config),bMapBrush.create()),addCustomFeatures()}function addCustomFeatures(){updateSummary(),bubbleMapUtil.createDialog(config.rootDiv,config.dialogDiv,"eQTL Boxplot"),addTissueSelect(),bMap.svg.on("mouseout",function(){bMap.tooltip.hide()}),addXLabelMouseEvents(),addBubbleMouseEvents(),addSortTissueByAlphaBetButton(),addSnpSearch(),addDataFilters(),addTissueBadges(),addSiteMarkers(),addTssDist(),addLD(),config.needMini&&bMapBrush.brushEvent()}function rerender(state){switch(function(){d3.selectAll("#xMarkerGroup").selectAll(".xMarker").transition().attr({fill:"none"})}(),state){case"dataFilter":config.needMini&&bMapMini.update(mat,state),bMap.update(mat,state),config.needMini&&bMapBrush.brushEvent();break;case"ldFilter":drawLD();break;case"sort":config.needMini&&bMapMini.update(mat,state),bMap.update(mat,state),addTissueBadges(),config.needMini&&bMapBrush.brushEvent();break;default:updateSummary(),config.needMini&&bMapMini.update(mat,state),bMap.update(mat,state),bMapBrush&&bMapBrush.update(bMapMini.scale),addSnpSearch(state),addSiteMarkers(state),addTissueBadges(),addTssDist(),addLD(),void 0!==snp&&sortTissuesBySnp(snp),config.needMini&&bMapBrush.brushEvent()}var _markSnp=function(){if(void 0!==snp){var _draw=function(g,scale){g.select("#xMarkerGroup").selectAll(".sortMarker").remove(),g.select("#xMarkerGroup").append("path").attr({d:d3.svg.symbol().type("triangle-down"),fill:"#000",col:snp}).classed("xMarker sortMarker",!0).attr("transform",function(d){return"translate("+scale.X(snp)+",0)"})};_draw(bMap.zoomGroup,bMap.scale),_draw(bMapBrush.svg,bMapMini.scale),bMap.zoomGroup.select("#xLabel").selectAll(".xlab").attr("font-weight",void 0).filter(function(d){return d==snp}).transition().attr({fill:"black","font-weight":"bold"})}};void 0!==snp&&_markSnp()}function hideSpinner(){$("#fountainTextG").hide()}function showSpinner(){$("#fountainTextG").show()}function mouseOverColumn(d){var colSelect='[col="'+d+'"]',col2Select='[col2="'+d+'"]';d3.selectAll(".ldLine").classed("bubbleMouseover",!1),d3.selectAll("circle"+colSelect).classed("bubbleMouseover",!0),d3.select("#tssrow").selectAll("rect"+colSelect).classed("bubbleMouseover",!0),d3.select("#ldwrapper").selectAll("rect"+colSelect).style({"stroke-width":2,stroke:"#aaa"}),d3.select("#ldwrapper").selectAll("rect"+col2Select).style({"stroke-width":2,stroke:"#aaa"}),d3.selectAll(".xlab"+colSelect).classed("textMouseover",!0),d3.selectAll(".ldLine"+colSelect).classed("bubbleMouseover",!0)}function mouseOutColumn(d){var colSelect='[col="'+d+'"]',col2Select='[col2="'+d+'"]';d3.selectAll("circle"+colSelect).classed("bubbleMouseover",!1),d3.selectAll("rect"+colSelect).classed("bubbleMouseover",!1),d3.select("#ldwrapper").selectAll("rect"+colSelect).style({"stroke-width":0}),d3.select("#ldwrapper").selectAll("rect"+col2Select).style({"stroke-width":0}),d3.selectAll(".xlab"+colSelect).classed("textMouseover",!1),d3.selectAll(".ldLine"+colSelect).classed("bubbleMouseover",!1)}function sortTissuesBySnp(selected){var _fetchData=function(data){return data.filter(function(d){return d.x==selected})},_sortEffectSize=function(a,b){return Math.abs(b.value)-Math.abs(a.value)},matched=_fetchData(mat.data).sort(_sortEffectSize).map(function(d){return d.y});if(matched.length!=mat.y)var missed=mat.y.filter(function(d){return matched.indexOf(d)<0});mat.y=matched.concat(missed),snp=selected,rerender("sort")}function addXLabelMouseEvents(){var _mouseover=function(d,i){useRsId?mat.snp[d].rsId:mat.snp[d].variantId;bMap.tooltip.show("click to sort tissue rows by: <br/>"+mat.snp[d].variantId+"<br/>"+mat.snp[d].rsId),mouseOverColumn(d,i),xLabelMouseOverEvents.length>0&&xLabelMouseOverEvents.forEach(function(e){e(d)})},_click=function(d){sortTissuesBySnp(d)},_mouseout=function(d){mouseOutColumn(d),xLabelMouseOutEvents.length>0&&xLabelMouseOutEvents.forEach(function(e){e(d)})};bMap.zoomGroup.selectAll(".xlab").style("cursor","pointer").on("mouseover",_mouseover).on("mouseout",_mouseout).on("click",_click)}function addBubbleMouseEvents(){var _mouseover=function(d){var info=d.variantId+"<br>"+d.rsId+"<br>"+d.y+"<br>normalized effect size (NES): "+d.value+"<br>";bMap.tooltip.show(info);var col='[col="'+d.x+'"]',row='[row="'+d.y+'"]';d3.selectAll(".xlab"+col).classed("textMouseover",!0),d3.selectAll(".ylab"+row).classed("textMouseover",!0),d3.select(this).classed("bubbleMouseover",!0)},_mouseout=function(){d3.selectAll(".xlab").classed("textMouseover",!1),d3.selectAll(".ylab").classed("textMouseover",!1),d3.selectAll(".dcircle").classed("bubbleMouseover",!1),bMap.tooltip.hide()},_click=function(d){$("#"+config.dialogDiv).dialog("open");var plotId="bbmap-"+mat.x.indexOf(d.x)+"-"+mat.y.indexOf(d.y);if(!$("#"+plotId).length){$modalBody=$("#"+config.dialogDiv+" .bbMap-content"),$modalBody.append('<div style="float:left" id="'+plotId+'"><span class="ui-icon ui-icon-closethick closePlot" id="'+plotId+'Close"></span><div id="'+plotId+'Plot"></div>'),d3.select("#"+plotId).on("mouseover",function(){_mouseover(d)}).on("mouseout",function(){_mouseout(d)}),$("#"+plotId+" .closePlot").click(function(){$("#"+plotId).empty(),$("#"+plotId).remove()});var plotDiv=d3.select("#"+plotId+"Plot"),url=urls.eqtlBoxplot(),plotConfig=gtexBubbleMapConfig.plotviz(d.x,d.y);new plotviz.EqtlPlot(plotDiv.node(),url,plotConfig).query(d.x,gene.gencodeId,d.y,gene.geneSymbol,plotConfig)}};bMap.zoomGroup.selectAll(".dcircle").on("mouseover",_mouseover).on("mouseout",_mouseout).on("click",_click)}function addSortTissueByAlphaBetButton(){var _sortByTissueAlphabet=function(){mat.y=mat.y.sort(function(a,b){return a>b?1:-1}),snp=void 0,rerender("sort")},_tooltip=function(){bMap.tooltip.show("Click to sort tissues alphabetically")},_addButton=function(selected){return selected.append("rect").attr({x:-100,y:-10,width:110,height:16,fill:"#eee",cursor:"pointer"})},_addText=function(selected){return selected.append("text").text("Sort Tissues Alphabetically").attr({x:-95,y:0,fill:"#000","font-size":8,"text-anchor":"start",class:"bbadge",cursor:"pointer"})},_addEvents=function(selected){selected.on("mouseover",_tooltip).on("click",_sortByTissueAlphabet)},g=bMap.zoomGroup.append("g");g.call(_addButton).call(_addEvents),g.call(_addText).call(_addEvents)}function addTissueSelect(){var _createSelectMenuModal=function(div,y){$("#"+div+" .modal-body").html("");var modal=d3.select("#"+div+" .modal-body").node(),menu=new plotviz.Filter(modal),_createMenu=function(){return y.map(function(d){return[d,!0]})},_createTextMap=function(){var textMap={};return y.forEach(function(d){if("undefined"!=typeof tissueMetadataJson&&d in tissueMetadataJson){if(!tissueMetadataJson[d].hasOwnProperty("tissueSiteDetail"))throw"Data structure parsing error.";textMap[d]=tissueMetadataJson[d].tissueName}else textMap[d]=d}),textMap},input={data:_createMenu(),textMap:_createTextMap()};return menu.generate(input),menu},menu=_createSelectMenuModal(config.modalDiv,mat.y),_filter=function(){var tissues=menu.selected().filter(function(d){return"All"!=d});if(0===tissues.length)return $("#"+config.modalDiv).modal("show"),void $("#"+config.modalDiv+" .modal-footer").text("Error! Select one or more tissues!");var data=DATA.filter(function(d){return tissues.indexOf(d.y)>-1}),_uniq=function(d,i,arr){return i==arr.indexOf(d)};mat={y:tissues,x:function(){return data.map(function(d){return d.x}).filter(_uniq).sort(function(a,b){return mat.snp[a].pos-mat.snp[b].pos})}(),data:data,snp:mat.snp},rerender("tissueSelect")};$("#"+config.modalDiv).on("hidden.bs.modal",_filter)}function updateSummary(){var _updateEqtlSummary=function(){return"("+gene.gencodeId+") "+gene.description+"<br>Gene Location: chromosome "+gene.chromosome+": "+gene.start+" - "+gene.end+" ("+gene.strand+") <br>eQTLs: "+mat.data.length+" eQTLs (FDR <= 5%), including "+mat.y.length+" tissues (rows), "+mat.x.length+" SNPs (columns)  <br>  "},_getGenePageUrl=function(geneName,linkText){var geneNameString="'"+geneName+"'";return void 0===linkText&&(linkText=geneName),'<a href="javascript:portalClient.eqtl.gotoGeneExpression('+geneNameString+')">'+linkText+"</a>"},_getBrowserUrl=function(featureId){return"<a href=\"javascript:gotoBrowser('"+featureId+"')\">eQTL Browser</a>"};$("#"+config.infoDiv).html(_updateEqtlSummary()),$("#genePageLink").html(_getGenePageUrl(gene.geneSymbol,"gene page")),$("#geneSymbol").html(_getGenePageUrl(gene.geneSymbol)),$("#browserLink").html(_getBrowserUrl(gene.geneSymbol))}function addTissueBadges(){var _tooltip=function(d){var info=config.badgeData[d]+" samples with genotype in <br>"+d;bMap.tooltip.show(info)},_createBadges=function(selected){selected.enter().append("ellipse"),selected.exit().remove(),selected.attr({cx:-8,cy:function(d){return bMap.scale.Y(d)},rx:11,ry:8,fill:"#999",cursor:"default"}).on("mouseover",_tooltip)},_createBadgeText=function(selected){selected.enter().append("text").text(function(d){return config.badgeData[d]}),selected.exit().remove(),selected.attr({x:-1,y:function(d){return bMap.scale.Y(d)+3},fill:"#fff","font-size":8,"text-anchor":"end",class:"bbadge",cursor:"default"}).on("mouseover",_tooltip)},id="tissueBadges",g=bMap.zoomGroup.select("#"+id),_render=function(){g=g.empty()?bMap.zoomGroup.append("g").attr("id",id):g,g.selectAll("ellipse").data(mat.y,function(d){return d}).call(_createBadges),g.selectAll("text").data(mat.y,function(d){return d}).call(_createBadgeText)};0==d3.keys(config.badgeData).length?(verbose&&console.info(urls.tissue()),d3.json(urls.tissue(),function(err,tjson){config.badgeData=gtexBubbleMapDataUtil.parseTissue(tjson),_render()})):_render()}function addSnpSearch(state){var _addSnpMarkers=function(isMini,data){var scale=isMini?bMapMini.scale:bMap.scale,xargs={g:isMini?bMapBrush.svg:bMap.zoomGroup,data:data,xscale:scale.X,markerAdjust:isMini?5:0};bubbleMapUtil.makeColumnMarkers(xargs)},_findSnps=function(){!function(){d3.selectAll("#xMarkerGroup").selectAll(".xMarker").classed("foundSnp",!1),bMap.zoomGroup.selectAll(".xlab").classed("textMatched",!1)}();var snp=$("#bbSnpSearch").val();if(snp.length>3){var __foundData=function(d){return 1==new RegExp(snp).test(d)},matched=mat.x.filter(__foundData);if(0==matched.length)return;_addSnpMarkers(!1,matched),_addSnpMarkers(!0,matched),d3.selectAll("#xMarkerGroup").selectAll(".xMarker").classed("foundSnp",!0);var __textHighlight=function(selected){selected.filter(function(d){return matched.indexOf(d)>=0}).classed("textMatched",!0)};bMap.zoomGroup.selectAll(".xlab").call(__textHighlight)}},_addKeyEvent=function(){$("#bbSnpSearch").keyup(_findSnps)},_createEmptyMarkerGroup=function(){void 0!==bMapBrush&&bubbleMapUtil.makeColumnMarkers({g:bMapBrush.svg}),bubbleMapUtil.makeColumnMarkers({g:bMap.zoomGroup})};switch(state){case"tissueSelect":_findSnps(),_createEmptyMarkerGroup();break;default:_addKeyEvent(),_createEmptyMarkerGroup()}}function addSiteMarkers(){var _drawMarker=function(isMini,thingy,type){var markerClass=type+"Marker";isMini?bMapBrush.svg.select("."+markerClass).remove():bMap.zoomGroup.select("."+markerClass).remove();var g=isMini?bMapBrush.svg.append("g"):bMap.zoomGroup.append("g");g.classed(markerClass,!0);var scale=isMini?bMapMini.scale:bMap.scale,x=scale.X(thingy)+.5*scale.X.rangeBand(),y=isMini?scale.Y.range()[0]-10:.5*-scale.Y.rangeBand(),direction="+"==gene.strand?scale.X.rangeBand():-scale.X.rangeBand(),__addLines=function(selected){selected.append("line").attr({x1:x,x2:x,y1:y,y2:scale.Y.range()[mat.y.length-1],stroke:"#999","stroke-width":"1",col:thingy}).classed("xMarker",!0),"tss"==type&&selected.append("line").attr({x1:x,x2:x+direction,y1:y,y2:y,stroke:"#999","stroke-width":"1",col:thingy}).classed("xMarker",!0)},__addTriangle=function(selected){var angle="+"==gene.strand?90:-90,s=isMini?.75:1;selected.append("path").attr({d:d3.svg.symbol().type("triangle-up"),col:thingy,fill:"#999"}).classed("xMarker",!0).attr("transform","translate("+(x+direction)+","+y+") rotate("+angle+") scale("+s+")")},__addCircle=function(selected){selected.append("circle").attr({r:3,cx:x,cy:y,class:"xMarker",col:thingy,fill:"#999"})},__addText=function(selected){selected.append("text").text(gene.geneSymbol+" "+type.toUpperCase()).attr({x:"+"==gene.strand?x-3*direction:x,y:y-3,fill:"#999","font-size":8,col:thingy}).classed("xMarker",!0)};g.call(__addLines),"tss"==type&&g.call(__addTriangle),"tes"==type&&g.call(__addCircle),isMini||(g.call(__addText),g.classed("additionalRow",!0))},_createTssSiteMarker=function(){var sites=mat.x.filter(function(x,i){if(i==mat.x.length-1)return!1;if(0==mat.snp[x].dist)return!0;var right=mat.x[i+1];return mat.snp[x].dist*mat.snp[right].dist<0});if(1!=sites.length)return console.error("TSS site not found"),null;_drawMarker(!1,sites[0],"tss"),config.needMini&&_drawMarker(!0,sites[0],"tss")},_createTesSiteMarker=function(){var sites=mat.x.filter(function(x,i){var tesPos="+"==gene.strand?gene.end:gene.start,right=mat.x[i+1]||void 0;return void 0!==right&&(mat.snp[x].pos-tesPos)*(mat.snp[right].pos-tesPos)<0});if(1!=sites.length)return void console.error("TES site not found");_drawMarker(!1,sites[0],"tes"),config.needMini&&_drawMarker(!0,sites[0],"tes")};_createTssSiteMarker(),_createTesSiteMarker()}function addTssDist(){var unit=1e5,range=["#000","#252525","#525252","#737373","#969696","#f0f0f0","#fff"],domain=[0,.005,.01,.1,.5,2,3,4,5].map(function(d){return d*unit}),cscale=d3.scale.linear().domain(domain).range(range),getPos=function(snp){var dist=Math.abs(mat.snp[snp].dist);return cscale(dist)},markFeatureClass=function(snp){var exons=gene.exons,snpPos=mat.snp[snp].pos,overlap=exons.filter(function(exon){if(!exon.hasOwnProperty("start")||!exon.hasOwnProperty("end"))throw"Exon data structure error.";return exon.start<=snpPos&&snpPos<=exon.end}),fClass="xMarker";return overlap.length>0?fClass+" exon":fClass+" noFeature"},_drawRects=function(rects){rects.enter().append("rect"),rects.exit().remove(),rects.attr({x:function(d){return bMap.scale.X(d)-.5*bMap.scale.X.rangeBand()},y:bMap.scale.Y(mat.y[mat.y.length-1])+bMap.scale.Y.rangeBand(),width:bMap.scale.X.rangeBand(),height:bMap.scale.Y.rangeBand(),fill:getPos,"stroke-width":1.2,class:markFeatureClass,col:function(d){return d}}).on("mouseover",function(d){var dist="+"==gene.strand?mat.snp[d].dist:0-mat.snp[d].dist,pos=mat.snp[d].pos,info=mat.snp[d].variantId+"<br>"+mat.snp[d].rsId+"<br>TSS distance: "+dist+"<br>Genomic location: "+pos+"<br>";d3.select(this).classed("exon")&&(info+="Exon Region"),bMap.tooltip.show(info),mouseOverColumn(d),xLabelMouseOverEvents.length>0&&xLabelMouseOverEvents.forEach(function(e){e(d)})}).on("mouseout",function(d){mouseOutColumn(d),xLabelMouseOutEvents.length>0&&xLabelMouseOutEvents.forEach(function(e){e(d)})})},_drawTextLabel=function(selected){bMap.zoomGroup.select("#tssLabel").remove(),selected.text("TSS Proximity").attr({id:"tssLabel",x:-60,y:bMap.scale.Y(mat.y[mat.y.length-1])+1.7*bMap.scale.Y.rangeBand(),fill:"#999","font-size":10})},id="tssRow",g=bMap.zoomGroup.select("#"+id),_render=function(){g=g.empty()?bMap.zoomGroup.append("g").attr({class:"additionalRow",id:"tssRow"}):g,g.selectAll("rect").data(mat.x,function(d){return d}).call(_drawRects),bMap.zoomGroup.append("text").call(_drawTextLabel),config.needMini&&bMapBrush.brushEvent()};void 0==gene.exons?(verbose&&console.info(urls.exons(gene.gencodeId)),d3.json(urls.exons(gene.gencodeId),function(err,exonJson){gene.exons=gtexBubbleMapDataUtil.parseExon(exonJson),_render()})):_render()}function addLD(){var top=config.needMini?parseInt(d3.select("#"+config.bbMapCanvasDiv).select("canvas").attr("height")):50;if(d3.select("#"+config.ldCanvasDiv).attr({style:"position: relative; top: "+top+"px; left:"+bMap.getPadding().left+"px;"}),void 0===config.ldData){var url=urls.ld(gene);verbose&&console.info(url),$.ajax({url:url,type:"GET",xhrFields:{withCredentials:!1},success:function(data){geneId===self.querying?(config.ldData={},data.ld.forEach(function(pair){config.ldData[pair[0]]=pair[1]}),bMapBrush&&bMapBrush.addEvent(drawLD),drawLD()):config.ldData={}}})}else drawLD()}function drawLD(){var min=config.ldCutoff,cellW=bMap.scale.X.range()[1]-bMap.scale.X.range()[0],_cscale=d3.scale.linear().domain([0,1]).range(["#fff","#000"]),xlist=bMapBrush?bMapBrush.xlist:bMap.scale.X.domain(),_buildPairs=function(){var ld=config.ldData,pairs=[];return xlist.forEach(function(x,i){xlist.forEach(function(x2,j){var r2=ld[x+","+x2]||ld[x2+","+x]||void 0;i==j&&pairs.push({x:x,y:x2,r2:1}),i<=j&&void 0!=r2&&r2>min&&pairs.push({x:x,y:x2,r2:r2})})}),pairs},data=_buildPairs(xlist),width=bMap.scale.X.range()[(bMapBrush?bMapBrush.xlist.length:bMap.scale.X.domain().length)-1]+cellW,height=width;d3.select("#"+config.ldCanvasDiv).style("height",height+"px");var _createCanvas=function(){return d3.select("#"+config.ldCanvasDiv).select("canvas").remove(),d3.select("#"+config.ldCanvasDiv).append("canvas").attr({width:width,height:height}).style({position:"absolute",top:0,left:0})},_transformCanvas=function(canvas,left,top){var context=canvas.node().getContext("2d");context.translate(left,top),context.rotate(-.25*Math.PI)},_createPosScale=function(){return{pos:function(d){var i=xlist.indexOf(d);if(-1!=i)return this.band()*i},data:function(){return data},band:function(){return cellW/Math.sqrt(2)},index:function(d){var i=xlist.indexOf(d);if(-1!=i)return i}}},_drawCanvas=function(canvas,xScale,snp){var context=canvas.node().getContext("2d");context.clearRect(0,0,canvas.width,canvas.height);var positions=[],scaling=1;xScale.data().forEach(function(d){var x,y,xBand,yBand,shiftValue,xShift,yShift;positions.push({x:xScale.pos(d.x),y:xScale.pos(d.y)}),context.beginPath(),context.fillStyle=_cscale(d.r2),xBand=xScale.band(),yBand=xScale.band(),shiftValue=Math.abs(xScale.index(d.x)-xScale.index(d.y)),xShift=shiftValue*(1-scaling)*xBand,yShift=-shiftValue*(1-scaling)*yBand+cellW/4,x=xScale.pos(d.x)+xShift,y=xScale.pos(d.y)+yShift,context.moveTo(x,y),context.lineTo(x+scaling*xBand,y+(1-scaling)*yBand),context.lineTo(x+xBand,y+yBand),context.lineTo(x+(1-scaling)*xBand,y+scaling*yBand),context.fill(),void 0===snp||d.x!=snp&&d.y!=snp||(context.lineWidth=1,context.strokeStyle="#fd8c94",context.stroke()),context.closePath()})},_createSvg=function(){return d3.select("#"+config.ldCanvasDiv).select("svg").remove(),d3.select("#"+config.ldCanvasDiv).append("svg").attr({id:"ldSvg",width:width,height:height}).style({position:"absolute",top:0,left:0,cursor:"none"})},_drawLines=function(){var initY=bMap.scale.Y(mat.y[mat.y.length-1])+1.7*bMap.scale.Y.rangeBand()+150,id="ldWrapper",_createGroup=function(){return bMap.zoomGroup.append("g").attr("id",id).classed("additionalRow",!0)},g=bMap.zoomGroup.select("#"+id);g.empty()&&(g=_createGroup());var lines=g.selectAll("line").data(xlist,function(d){return d});lines.enter().append("line"),lines.exit().remove(),lines.attr({x1:function(d){return bMap.scale.X(d)},x2:function(d){return bMap.scale.X(d)},y1:initY,y2:initY+80,stroke:"#cdcdcd","stroke-width":1,col:function(d){return d}}).classed("ldline",!0)},_getRad=function(theta){return Math.PI*(theta/180)},_highlight=function(svg,id,scale,dlist){var g=svg.select("#"+id).empty()?svg.append("g").attr("id",id):svg.select("#"+id),line=d3.svg.line().x(function(d){return d.x}).y(function(d){return d.y}),lines=g.selectAll("path").data(dlist,function(d){return d.x+d.y});return lines.enter().append("path"),lines.exit().remove(),lines.attr({d:function(d){var x,y,xBand,yBand,shiftValue,xShift,yShift,scaling=1;return xBand=scale.band(),yBand=scale.band(),shiftValue=Math.abs(scale.index(d.x)-scale.index(d.y)),xShift=shiftValue*(1-scaling)*xBand,yShift=-shiftValue*(1-scaling)*yBand+cellW/4,x=scale.pos(d.x)+xShift,y=scale.pos(d.y)+yShift,line([{x:x,y:y},{x:x+scaling*xBand,y:y+(1-scaling)*yBand},{x:x+xBand,y:y+yBand},{x:x+(1-scaling)*xBand,y:y+scaling*yBand}])+"Z"},fill:"none",stroke:"grey","stroke-width":1}),lines},_addSvgEvents=function(svg,cursor,band){svg.on("mousemove",function(){cursor.attr("display",""),d3.selectAll(".xlab").classed("textMouseover",!1),d3.selectAll(".ldLine").classed("bubbleMouseover",!1);var pos=d3.mouse(this),x=pos[0],y=pos[1],rad=_getRad(45);x2=x*Math.cos(rad)-y*Math.sin(rad),y2=x*Math.sin(rad)+y*Math.cos(rad)-band;var i=Math.floor(x2/band)+1,j=Math.floor(y2/band),show=!0,rsq=config.ldData[xlist[i]+","+xlist[j]]||config.ldData[xlist[j]+","+xlist[i]];if(xlist[i]==xlist[j]?rsq=1:void 0===rsq&&(show=!1),show){var message=xlist[i]+"-"+xlist[j]+": "+rsq.toPrecision(3);bMap.tooltip.show(message),cursor.attr("stroke","red").attr("transform","translate("+x+","+y+") rotate(-45)");var colSelect='[col="'+xlist[i]+'"]',colSelect2='[col="'+xlist[j]+'"]';d3.selectAll(".xlab"+colSelect).classed("textMouseover",!0),d3.selectAll(".xlab"+colSelect2).classed("textMouseover",!0),d3.selectAll(".ldLine"+colSelect).classed("bubbleMouseover",!0),d3.selectAll(".ldLine"+colSelect2).classed("bubbleMouseover",!0)}else bMap.tooltip.hide(),cursor.attr("stroke","#ddd").attr("transform","translate("+x+","+y+") rotate(-45)")}),svg.on("mouseleave",function(){d3.selectAll(".xlab").classed("textMouseover",!1),d3.selectAll(".lbLine").classed("bubbleMouseover",!1),cursor.attr("display","none")})},_drawLdLegend=function(svg,ldTitle){var g=svg.append("g").attr("id","#ldLegend"),domain=[.1,1],range=["#f7f7f7","#000000"],scale=d3.scale.linear().domain(domain).range(range),cellW=bMap.scale.X.range()[1]-bMap.scale.X.range()[0],w=cellW,initX=10,initY=60;g.append("text").text(ldTitle).attr({x:0,y:0,"font-size":10,fill:"black",transform:"translate("+initX+", "+(initY+150)+") rotate(-90)"});var data=d3.range(0,1.1,.1);initX+=10,initY+=30;var colors=[];g.selectAll("rect").data(data).enter().append("rect").attr({width:w,height:w,x:initX,y:function(d,i){return initY+i*w},fill:function(d){return colors.push(scale(d)),scale(1-d)}}),data=data.map(function(d){return(1-d).toFixed(1)}),g.selectAll(".ldLabels").data(data).enter().append("text").text(function(d){return d}).attr({x:initX+10+w,y:function(d,i){return initY+i*w+2},"font-size":6,fill:function(d,i){return i%2==1?"black":"#aaa"}})},canvas=_createCanvas(),pScale=_createPosScale();_transformCanvas(canvas,pScale.band()/2,pScale.band()),_drawCanvas(canvas,pScale),_drawLines(xlist);var svg=_createSvg();_drawLdLegend(svg,config.ldTitle);var cursor=_highlight(svg,"ldCursor",pScale,data.slice(0,1));cursor.attr("display","none"),_addSvgEvents(svg,cursor,pScale.band()),xLabelMouseOverEvents.push(function(snp){var filtered=data.filter(function(d){return d.x==snp||d.y==snp});_highlight(svg,"ldHighlight",pScale,filtered).attr("stroke","red").attr("transform","translate("+pScale.band()/2+","+pScale.band()+") rotate(-45)")}),xLabelMouseOutEvents.push(function(){svg.select("#ldHighlight").selectAll("path").remove()})}function addDataFilters(){var _storeFilter=function(name,callback){dataFilters[name].func=callback},_reportFilterResults=function(){var l=mat.data.filter(function(d){return(d.filters?d3.values(d.filters).filter(function(d){return d}):[]).length>0}).length,L=mat.data.length,after=L-l;l>0?($("#filterInfo").show(),$("#filterInfo").text("Remaining number of eQTLs: "+after+" ("+(after/L*100).toFixed(2)+"%)")):$("#filterInfo").hide()},_createFilter=function(x,isMax,useAbs){var myfilter=function(v,state){void 0===state&&(state="dataFilter"),dataFilters[x].value=v;var fClass=x+"Filtered";useAbs&&(v=Math.abs(v));var __smallerEqual=function(d){return useAbs?Math.abs(d[x])<=v:d[x]<=v},__largerThan=function(d){return useAbs?Math.abs(d[x])>v:d[x]>v};if(isMax);else{var __failed=function(selected){selected.filter(__smallerEqual).classed(fClass,!0)},__passed=function(selected){selected.filter(__largerThan).classed(fClass,!1)};mat.data.filter(function(d){void 0===d.filters&&(d.filters={}),d.filters[x]=useAbs?Math.abs(d[x])<=v:d[x]<=v}),rerender(state);var zoomCircles=bMap.zoomGroup.selectAll(".dcircle");zoomCircles.call(__failed),zoomCircles.call(__passed)}};return _storeFilter(x,myfilter),myfilter},_filterP=_createFilter("r",!1,!1),_filterE=_createFilter("value",!1,!0),_filterLD=_createFilter("ld",!1,!1);!function(){$("#pvalueSlider").on("change mousemove",function(){var v=$(this).val();$("#pvalueLimit").val(v),_filterP(parseFloat(v)),_reportFilterResults()}),$("#pvalueLimit").keydown(function(e){if(13==e.keyCode){var v=$("#pvalueLimit").val();$("#pvalueSlider").val(v),_filterP(parseFloat(v)),_reportFilterResults()}}),$("#effectSizeSlider").on("change mousemove",function(){var v=$(this).val();$("#effectSizeLimit").val(v),_filterE(parseFloat(v)),_reportFilterResults()}),$("#effectSizeLimit").keydown(function(e){if(13==e.keyCode){var v=$("#effectSizeLimit").val();$("#effectSizeSlider").val(v),_filterE(parseFloat(v)),_reportFilterResults()}}),$("#linkageDisequilibriumSlider").on("change mousemove",function(){var v=$(this).val();config.ldCutoff=parseFloat(v),$("#linkageDisequilibriumLimit").val(v),_filterLD(parseFloat(v),"ldFilter"),_reportFilterResults()}),$("#linkageDisequilibriumLimit").keydown(function(e){if(13==e.keyCode){var v=$("#linkageDisequilibriumLimit").val();config.ldCutoff=parseFloat(v),$("#linkageDisequilibriumSlider").val(v),_filterLD(parseFloat(v),"ldFilter"),_reportFilterResults()}})}()}var snp,bMap,bMapMini,bMapBrush,self=this,verbose=!1,gene=void 0,mat={y:[],x:[],data:[],snp:{},xlab:[]},TISSUES=[],DATA=[],dataFilters={r:{func:void 0,value:void 0},value:{func:void 0,value:void 0},ld:{func:void 0,value:void 0}},xLabelMouseOverEvents=[],xLabelMouseOutEvents=[];this.querying=geneId,this.getGeneId=function(){return geneId},this.launch=function(){clear(config.bbMapDiv,config.infoDiv,config.bbMapCanvasDiv),gene=void 0,verbose&&console.info(urls.gene(geneId)),d3.json(urls.gene(geneId),function(error,gjson){if(void 0===gjson)throw hideSpinner(),"Fatal Error: Gene data retrieval failed";gene=gtexBubbleMapDataUtil.parseGene(gjson,geneId),verbose&&(console.info(gene),console.info(urls.eqtl(geneId))),d3.json(urls.eqtl(geneId),function(err,eqtlJson){if(void 0===eqtlJson)throw hideSpinner(),"Fatal Error: eQTL data retrieval failed";if(void 0===(mat=gtexBubbleMapDataUtil.parseEqtl(eqtlJson,gene.tss)))throw $("#"+config.rootDiv).html("No eQTL data found for "+geneId),"No eQTL data found. Visualization terminated.";TISSUES=mat.y.slice(0),DATA=mat.data.slice(0),hideSpinner(),setMini(),render()})})},this.changeXLabels=function(userRsId){userRsId?bMap.zoomGroup.selectAll(".xlab").each(function(){var varId=$(this).attr("col");$(this).text(mat.snp[varId].rsId)}):bMap.zoomGroup.selectAll(".xlab").each(function(){var varId=$(this).attr("col");$(this).text(mat.snp[varId].truncatedVariantId)})}};